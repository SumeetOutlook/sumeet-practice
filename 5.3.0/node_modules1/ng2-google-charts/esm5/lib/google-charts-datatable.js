import { __decorate, __values } from "tslib";
import { EventEmitter, Output, } from '@angular/core';
var GoogleChartsDataTable = /** @class */ (function () {
    function GoogleChartsDataTable(opt) {
        this.opt = opt;
        this.dataTableChanged = new EventEmitter();
        if (opt) {
            this._setDataTable(opt.dataTable, opt.firstRowIsData);
        }
    }
    GoogleChartsDataTable.prototype.send = function () {
        var _this = this;
        if (this.query === undefined) {
            return;
        }
        this.query.send(function (queryResponse) {
            _this.setDataTable(queryResponse.getDataTable());
            if (_this.opt.queryCallback) {
                _this.opt.queryCallback(queryResponse);
            }
        });
    };
    GoogleChartsDataTable.prototype.init = function (opt) {
        var _this = this;
        if (opt) {
            this.opt = opt;
        }
        if (this.tid !== undefined) {
            // doesn't work, see https://github.com/google/google-visualization-issues/issues/2381
            // this.query.abort();
            window.clearInterval(this.tid);
            this.tid = undefined;
        }
        if (this.opt.dataSourceUrl) {
            this.query = new google.visualization.Query(this.opt.dataSourceUrl);
            if (this.opt.query) {
                this.query.setQuery(this.opt.query);
            }
            if (this.opt.timeout !== undefined) {
                this.query.setTimeout(this.opt.timeout);
            }
            if (this.opt.refreshInterval) {
                // this.query.setRefreshInterval(this.opt.refreshInterval);
                this.tid = window.setInterval(function () {
                    _this.send();
                }, this.opt.refreshInterval * 1000);
            }
            this.send();
        }
        else {
            this.setDataTable(this.opt.dataTable);
        }
    };
    /**
     * @returns Underlying google.visualization.DataTable
     */
    GoogleChartsDataTable.prototype.getDataTable = function () {
        return this.dataTable;
    };
    GoogleChartsDataTable.prototype.setDataTable = function (dt, firstRowIsData) {
        if (firstRowIsData === undefined) {
            firstRowIsData = this.opt.firstRowIsData;
        }
        this._setDataTable(dt, firstRowIsData);
        this.dataTableChanged.emit(this.dataTable);
    };
    GoogleChartsDataTable.prototype._setDataTable = function (dt, firstRowIsData) {
        if (Array.isArray(dt)) {
            dt = google.visualization.arrayToDataTable(dt, firstRowIsData);
        }
        this.dataTable = dt;
        this.reformat();
    };
    /**
     * Applies formatters to data columns, if defined
     */
    GoogleChartsDataTable.prototype.reformat = function () {
        var e_1, _a, e_2, _b, e_3, _c;
        var dt = this.dataTable;
        if (dt === undefined) {
            return;
        }
        if (this.opt.formatters === undefined) {
            return;
        }
        try {
            for (var _d = __values(this.opt.formatters), _e = _d.next(); !_e.done; _e = _d.next()) {
                var formatterConfig = _e.value;
                var formatter = void 0;
                if (formatterConfig.type === 'PatternFormat') {
                    var fmtOptions = formatterConfig.options;
                    formatter = new google.visualization.PatternFormat(fmtOptions.pattern);
                    formatter.format(dt, formatterConfig.columns, fmtOptions.dstColumnIndex);
                    continue;
                }
                var formatterConstructor = google.visualization[formatterConfig.type];
                var formatterOptions = formatterConfig.options;
                formatter = new formatterConstructor(formatterOptions);
                if (formatterConfig.type === 'ColorFormat' && formatterOptions) {
                    var fmtOptions = formatterOptions;
                    try {
                        for (var _f = (e_2 = void 0, __values(fmtOptions.ranges)), _g = _f.next(); !_g.done; _g = _f.next()) {
                            var range = _g.value;
                            if (typeof (range.fromBgColor) !== 'undefined'
                                && typeof (range.toBgColor) !== 'undefined') {
                                formatter.addGradientRange(range.from, range.to, range.color, range.fromBgColor, range.toBgColor);
                            }
                            else {
                                formatter.addRange(range.from, range.to, range.color, range.bgcolor);
                            }
                        }
                    }
                    catch (e_2_1) { e_2 = { error: e_2_1 }; }
                    finally {
                        try {
                            if (_g && !_g.done && (_b = _f.return)) _b.call(_f);
                        }
                        finally { if (e_2) throw e_2.error; }
                    }
                }
                try {
                    for (var _h = (e_3 = void 0, __values(formatterConfig.columns)), _j = _h.next(); !_j.done; _j = _h.next()) {
                        var col = _j.value;
                        formatter.format(dt, col);
                    }
                }
                catch (e_3_1) { e_3 = { error: e_3_1 }; }
                finally {
                    try {
                        if (_j && !_j.done && (_c = _h.return)) _c.call(_h);
                    }
                    finally { if (e_3) throw e_3.error; }
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_e && !_e.done && (_a = _d.return)) _a.call(_d);
            }
            finally { if (e_1) throw e_1.error; }
        }
    };
    __decorate([
        Output()
    ], GoogleChartsDataTable.prototype, "dataTableChanged", void 0);
    return GoogleChartsDataTable;
}());
export { GoogleChartsDataTable };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29vZ2xlLWNoYXJ0cy1kYXRhdGFibGUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZzItZ29vZ2xlLWNoYXJ0cy8iLCJzb3VyY2VzIjpbImxpYi9nb29nbGUtY2hhcnRzLWRhdGF0YWJsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBc0ZBLE9BQU8sRUFDTCxZQUFZLEVBQ1osTUFBTSxHQUNQLE1BQU0sZUFBZSxDQUFDO0FBRXZCO0lBT0UsK0JBQW9CLEdBQW1DO1FBQW5DLFFBQUcsR0FBSCxHQUFHLENBQWdDO1FBRjdDLHFCQUFnQixHQUFzQixJQUFJLFlBQVksRUFBRSxDQUFDO1FBR2pFLElBQUksR0FBRyxFQUFFO1lBQ1AsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztTQUN2RDtJQUNILENBQUM7SUFFTyxvQ0FBSSxHQUFaO1FBQUEsaUJBVUM7UUFUQyxJQUFJLElBQUksQ0FBQyxLQUFLLEtBQUssU0FBUyxFQUFFO1lBQzVCLE9BQU87U0FDUjtRQUNELElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFVBQUMsYUFBa0I7WUFDakMsS0FBSSxDQUFDLFlBQVksQ0FBQyxhQUFhLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQztZQUNoRCxJQUFJLEtBQUksQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFO2dCQUMxQixLQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsQ0FBQzthQUN2QztRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVNLG9DQUFJLEdBQVgsVUFBWSxHQUFvQztRQUFoRCxpQkE4QkM7UUE3QkMsSUFBSSxHQUFHLEVBQUU7WUFDUCxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztTQUNoQjtRQUVELElBQUksSUFBSSxDQUFDLEdBQUcsS0FBSyxTQUFTLEVBQUU7WUFDMUIsc0ZBQXNGO1lBQ3RGLHNCQUFzQjtZQUN0QixNQUFNLENB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QU0sR0FBRyxXQUFBO3dCQUNaLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLEdBQUcsQ0FBQyxDQUFDO3FCQUMzQjs7Ozs7Ozs7O2FBQ0Y7Ozs7Ozs7OztJQUNILENBQUM7SUF2SFM7UUFBVCxNQUFNLEVBQUU7bUVBQTBEO0lBd0hyRSw0QkFBQztDQUFBLEFBN0hELElBNkhDO1NBN0hZLHFCQUFxQiIsInNvdXJjZXNDb250ZW50IjpbImRlY2xhcmUgdmFyIGdvb2dsZTogYW55O1xuXG5leHBvcnQgaW50ZXJmYWNlIEFycm93Rm9ybWF0SW50ZXJmYWNlIHtcbiAgYmFzZTogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEJhckZvcm1hdEludGVyZmFjZSB7XG4gIGJhc2U/OiBudW1iZXI7XG4gIGNvbG9yTmVnYXRpdmU/OiBzdHJpbmc7XG4gIGNvbG9yUG9zaXRpdmU/OiBzdHJpbmc7XG4gIGRyYXdaZXJvTGluZT86IGJvb2xlYW47XG4gIG1heD86IG51bWJlcjtcbiAgbWluPzogbnVtYmVyO1xuICBzaG93VmFsdWU/OiBib29sZWFuO1xuICB3aWR0aD86IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBSYW5nZUludGVyZmFjZSB7XG4gIGZyb206IG51bWJlciB8IERhdGUgfCBudW1iZXJbXTtcbiAgdG86IG51bWJlciB8IERhdGUgfCBudW1iZXJbXTtcbiAgY29sb3I/OiBzdHJpbmc7XG4gIGJnY29sb3I/OiBzdHJpbmc7XG4gIGZyb21CZ0NvbG9yPzogc3RyaW5nO1xuICB0b0JnQ29sb3I/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29sb3JGb3JtYXRJbnRlcmZhY2Uge1xuICByYW5nZXM/OiBSYW5nZUludGVyZmFjZVtdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIERhdGVGb3JtYXQge1xuICBmb3JtYXRUeXBlPzogc3RyaW5nO1xuICBwYXR0ZXJuPzogc3RyaW5nO1xuICB0aW1lWm9uZT86IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBOdW1iZXJGb3JtYXRJbnRlcmZhY2Uge1xuICBkZWNpbWFsU3ltYm9sPzogc3RyaW5nO1xuICBmcmFjdGlvbkRpZ2l0cz86IG51bWJlcjtcbiAgZ3JvdXBpbmdTeW1ib2w/OiBzdHJpbmc7XG4gIG5lZ2F0aXZlQ29sb3I/OiBzdHJpbmc7XG4gIG5lZ2F0aXZlUGFyZW5zPzogYm9vbGVhbjtcbiAgcGF0dGVybj86IHN0cmluZztcbiAgcHJlZml4Pzogc3RyaW5nO1xuICBzdWZmaXg/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUGF0dGVybkZvcm1hdEludGVyZmFjZSB7XG4gIHBhdHRlcm46IHN0cmluZztcbiAgZHN0Q29sdW1uSW5kZXg/OiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRm9ybWF0dGVySW50ZXJmYWNlIHtcbiAgdHlwZTogc3RyaW5nO1xuICBvcHRpb25zPzogKFxuICAgIEFycm93Rm9ybWF0SW50ZXJmYWNlXG4gICAgfCBCYXJGb3JtYXRJbnRlcmZhY2VcbiAgICB8IENvbG9yRm9ybWF0SW50ZXJmYWNlXG4gICAgfCBEYXRlRm9ybWF0XG4gICAgfCBOdW1iZXJGb3JtYXRJbnRlcmZhY2VcbiAgICB8IFBhdHRlcm5Gb3JtYXRJbnRlcmZhY2VcbiAgKTtcbiAgY29sdW1uczogbnVtYmVyW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgR29vZ2xlQ2hhcnRzRGF0YVRhYmxlSW50ZXJmYWNlIHtcbiAgZGF0YVRhYmxlPzogYW55O1xuICBmaXJzdFJvd0lzRGF0YT86IGJvb2xlYW47XG4gIHF1ZXJ5Pzogc3RyaW5nO1xuICBkYXRhU291cmNlVXJsPzogc3RyaW5nO1xuXG4gIC8qKiBSZWZyZXNoIGludGVydmFsLCBpbiBzZWNvbmRzLCB3aGVuIHVzaW5nIHJlbW90ZSBkYXRhIHNvdXJjZS4gKi9cbiAgcmVmcmVzaEludGVydmFsPzogbnVtYmVyO1xuXG4gIC8qKiBUaW1lb3V0IGluIHNlY29uZHMsIHdoZW4gdXNpbmcgcmVtb3RlIGRhdGEgc291cmNlICovXG4gIHRpbWVvdXQ/OiBudW1iZXI7XG5cbiAgLyoqIENhbGxlZCBhZnRlciBxdWVyeSBleGVjdXRlZC4gRGF0YVRhYmxlIGlzIHVwZGF0ZWQgYXV0b21hdGljYWxseS5cbiAgICogQHBhcmFtIHF1ZXJ5UmVzcG9uc2UgZ29vZ2xlLnZpc3VhbGl6YXRpb24uUXVlcnlSZXNwb25zZVxuICAgKi9cbiAgcXVlcnlDYWxsYmFjaz86IChxdWVyeVJlc3BvbnNlOiBhbnkpID0+IGFueTtcblxuICBmb3JtYXR0ZXJzPzogRm9ybWF0dGVySW50ZXJmYWNlW107XG4gIHZpZXc/OiBzdHJpbmcgfCBvYmplY3QgfCBvYmplY3RbXTtcbn1cblxuaW1wb3J0IHtcbiAgRXZlbnRFbWl0dGVyLFxuICBPdXRwdXQsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5leHBvcnQgY2xhc3MgR29vZ2xlQ2hhcnRzRGF0YVRhYmxlIHtcbiAgcHJpdmF0ZSBkYXRhVGFibGU6IGFueTtcbiAgcHVibGljIHF1ZXJ5OiBhbnk7XG4gIHB1YmxpYyB0aWQ6IGFueTtcblxuICBAT3V0cHV0KCkgZGF0YVRhYmxlQ2hhbmdlZDogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBvcHQ6IEdvb2dsZUNoYXJ0c0RhdGFUYWJsZUludGVyZmFjZSkge1xuICAgIGlmIChvcHQpIHtcbiAgICAgIHRoaXMuX3NldERhdGFUYWJsZShvcHQuZGF0YVRhYmxlLCBvcHQuZmlyc3RSb3dJc0RhdGEpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2VuZCgpIHtcbiAgICBpZiAodGhpcy5xdWVyeSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMucXVlcnkuc2VuZCgocXVlcnlSZXNwb25zZTogYW55KSA9PiB7XG4gICAgICB0aGlzLnNldERhdGFUYWJsZShxdWVyeVJlc3BvbnNlLmdldERhdGFUYWJsZSgpKTtcbiAgICAgIGlmICh0aGlzLm9wdC5xdWVyeUNhbGxiYWNrKSB7XG4gICAgICAgIHRoaXMub3B0LnF1ZXJ5Q2FsbGJhY2socXVlcnlSZXNwb25zZSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgaW5pdChvcHQ/OiBHb29nbGVDaGFydHNEYXRhVGFibGVJbnRlcmZhY2UpIHtcbiAgICBpZiAob3B0KSB7XG4gICAgICB0aGlzLm9wdCA9IG9wdDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy50aWQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgLy8gZG9lc24ndCB3b3JrLCBzZWUgaHR0cHM6Ly9naXRodWIuY29tL2dvb2dsZS9nb29nbGUtdmlzdWFsaXphdGlvbi1pc3N1ZXMvaXNzdWVzLzIzODFcbiAgICAgIC8vIHRoaXMucXVlcnkuYWJvcnQoKTtcbiAgICAgIHdpbmRvdy5jbGVhckludGVydmFsKHRoaXMudGlkKTtcbiAgICAgIHRoaXMudGlkID0gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGlmICh0aGlzLm9wdC5kYXRhU291cmNlVXJsKSB7XG4gICAgICB0aGlzLnF1ZXJ5ID0gbmV3IGdvb2dsZS52aXN1YWxpemF0aW9uLlF1ZXJ5KHRoaXMub3B0LmRhdGFTb3VyY2VVcmwpO1xuICAgICAgaWYgKHRoaXMub3B0LnF1ZXJ5KSB7XG4gICAgICAgIHRoaXMucXVlcnkuc2V0UXVlcnkodGhpcy5vcHQucXVlcnkpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMub3B0LnRpbWVvdXQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aGlzLnF1ZXJ5LnNldFRpbWVvdXQodGhpcy5vcHQudGltZW91dCk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5vcHQucmVmcmVzaEludGVydmFsKSB7XG4gICAgICAgIC8vIHRoaXMucXVlcnkuc2V0UmVmcmVzaEludGVydmFsKHRoaXMub3B0LnJlZnJlc2hJbnRlcnZhbCk7XG4gICAgICAgIHRoaXMudGlkID0gd2luZG93LnNldEludGVydmFsKCgpID0+IHtcbiAgICAgICAgICB0aGlzLnNlbmQoKTtcbiAgICAgICAgfSwgdGhpcy5vcHQucmVmcmVzaEludGVydmFsICogMTAwMCk7XG4gICAgICB9XG4gICAgICB0aGlzLnNlbmQoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zZXREYXRhVGFibGUodGhpcy5vcHQuZGF0YVRhYmxlKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMgVW5kZXJseWluZyBnb29nbGUudmlzdWFsaXphdGlvbi5EYXRhVGFibGVcbiAgICovXG5cbiAgcHVibGljIGdldERhdGFUYWJsZSgpIHtcbiAgICByZXR1cm4gdGhpcy5kYXRhVGFibGU7XG4gIH1cblxuICBwdWJsaWMgc2V0RGF0YVRhYmxlKGR0OiBhbnksIGZpcnN0Um93SXNEYXRhPzogYm9vbGVhbikge1xuICAgIGlmIChmaXJzdFJvd0lzRGF0YSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBmaXJzdFJvd0lzRGF0YSA9IHRoaXMub3B0LmZpcnN0Um93SXNEYXRhO1xuICAgIH1cbiAgICB0aGlzLl9zZXREYXRhVGFibGUoZHQsIGZpcnN0Um93SXNEYXRhKTtcbiAgICB0aGlzLmRhdGFUYWJsZUNoYW5nZWQuZW1pdCh0aGlzLmRhdGFUYWJsZSk7XG4gIH1cblxuICBwcml2YXRlIF9zZXREYXRhVGFibGUoZHQ6IGFueSwgZmlyc3RSb3dJc0RhdGE/OiBib29sZWFuKSB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkoZHQpKSB7XG4gICAgICBkdCA9IGdvb2dsZS52aXN1YWxpemF0aW9uLmFycmF5VG9EYXRhVGFibGUoZHQsIGZpcnN0Um93SXNEYXRhKTtcbiAgICB9XG4gICAgdGhpcy5kYXRhVGFibGUgPSBkdDtcbiAgICB0aGlzLnJlZm9ybWF0KCk7XG4gIH1cblxuICAvKipcbiAgICogQXBwbGllcyBmb3JtYXR0ZXJzIHRvIGRhdGEgY29sdW1ucywgaWYgZGVmaW5lZFxuICAgKi9cblxuICBwdWJsaWMgcmVmb3JtYXQoKSB7XG4gICAgY29uc3QgZHQgPSB0aGlzLmRhdGFUYWJsZTtcbiAgICBpZiAoZHQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0aGlzLm9wdC5mb3JtYXR0ZXJzID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IGZvcm1hdHRlckNvbmZpZyBvZiB0aGlzLm9wdC5mb3JtYXR0ZXJzKSB7XG4gICAgICBsZXQgZm9ybWF0dGVyOiBhbnk7XG4gICAgICBpZiAoZm9ybWF0dGVyQ29uZmlnLnR5cGUgPT09ICdQYXR0ZXJuRm9ybWF0Jykge1xuICAgICAgICBjb25zdCBmbXRPcHRpb25zID0gZm9ybWF0dGVyQ29uZmlnLm9wdGlvbnMgYXMgUGF0dGVybkZvcm1hdEludGVyZmFjZTtcbiAgICAgICAgZm9ybWF0dGVyID0gbmV3IGdvb2dsZS52aXN1YWxpemF0aW9uLlBhdHRlcm5Gb3JtYXQoZm10T3B0aW9ucy5wYXR0ZXJuKTtcbiAgICAgICAgZm9ybWF0dGVyLmZvcm1hdChkdCwgZm9ybWF0dGVyQ29uZmlnLmNvbHVtbnMsIGZtdE9wdGlvbnMuZHN0Q29sdW1uSW5kZXgpO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZm9ybWF0dGVyQ29uc3RydWN0b3IgPSBnb29nbGUudmlzdWFsaXphdGlvbltmb3JtYXR0ZXJDb25maWcudHlwZV07XG4gICAgICBjb25zdCBmb3JtYXR0ZXJPcHRpb25zID0gZm9ybWF0dGVyQ29uZmlnLm9wdGlvbnM7XG4gICAgICBmb3JtYXR0ZXIgPSBuZXcgZm9ybWF0dGVyQ29uc3RydWN0b3IoZm9ybWF0dGVyT3B0aW9ucyk7XG4gICAgICBpZiAoZm9ybWF0dGVyQ29uZmlnLnR5cGUgPT09ICdDb2xvckZvcm1hdCcgJiYgZm9ybWF0dGVyT3B0aW9ucykge1xuICAgICAgICBjb25zdCBmbXRPcHRpb25zID0gZm9ybWF0dGVyT3B0aW9ucyBhcyBDb2xvckZvcm1hdEludGVyZmFjZTtcbiAgICAgICAgZm9yIChjb25zdCByYW5nZSBvZiBmbXRPcHRpb25zLnJhbmdlcykge1xuICAgICAgICAgIGlmICh0eXBlb2YgKHJhbmdlLmZyb21CZ0NvbG9yKSAhPT0gJ3VuZGVmaW5lZCdcbiAgICAgICAgICAgICAgJiYgdHlwZW9mIChyYW5nZS50b0JnQ29sb3IpICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgZm9ybWF0dGVyLmFkZEdyYWRpZW50UmFuZ2UocmFuZ2UuZnJvbSwgcmFuZ2UudG8sXG4gICAgICAgICAgICAgIHJhbmdlLmNvbG9yLCByYW5nZS5mcm9tQmdDb2xvciwgcmFuZ2UudG9CZ0NvbG9yKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZm9ybWF0dGVyLmFkZFJhbmdlKHJhbmdlLmZyb20sIHJhbmdlLnRvLCByYW5nZS5jb2xvciwgcmFuZ2UuYmdjb2xvcik7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGZvciAoY29uc3QgY29sIG9mIGZvcm1hdHRlckNvbmZpZy5jb2x1bW5zKSB7XG4gICAgICAgIGZvcm1hdHRlci5mb3JtYXQoZHQsIGNvbCk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=