import { __awaiter, __decorate } from "tslib";
import { Component, ElementRef, OnInit, Input, Output, EventEmitter } from '@angular/core';
import { GoogleChartsLoaderService } from '../google-charts-loader.service';
import { GoogleChartsDataTable } from '../google-charts-datatable';
import { ChartHTMLTooltip } from './chart-html-tooltip';
let GoogleChartComponent = class GoogleChartComponent {
    constructor(el, loaderService) {
        this.el = el;
        this.mouseOverListener = (item) => {
            const event = this.parseMouseEvent(item);
            event.tooltip = this.getHTMLTooltip();
            return event;
        };
        this.mouseOutListener = (item) => {
            const event = this.parseMouseEvent(item);
            return event;
        };
        this.selectListener = () => {
            const event = {
                message: 'select',
                row: null,
                column: null,
                selectedRowValues: [],
                selectedRowFormattedValues: [],
                columnLabel: ''
            };
            const s = this.wrapper.visualization.getSelection();
            const gs = s[s.length - 1];
            if (!gs) {
                event.message = 'deselect';
                return event;
            }
            const selection = gs;
            if (gs.row != null) {
                event.row = selection.row;
                const selectedRowValues = [];
                const selectedRowFormattedValues = [];
                const dataTable = this.wrapper.getDataTable();
                const numberOfColumns = dataTable.getNumberOfColumns();
                for (let i = 0; i < numberOfColumns; i++) {
                    selectedRowValues.push(dataTable.getValue(selection.row, i));
                    selectedRowFormattedValues.push(dataTable.getFormattedValue(selection.row, i));
                }
                event.selectedRowValues = selectedRowValues;
                event.selectedRowFormattedValues = selectedRowFormattedValues;
            }
            if (selection.column != null) {
                event.column = selection.column;
                event.columnLabel = this.getColumnLabelAtPosition(selection);
            }
            if (gs.name) {
                event.columnLabel = gs.name;
            }
            return event;
        };
        this.loaderService = loaderService;
        this.chartSelect = new EventEmitter();
        this.chartSelectOneTime = new EventEmitter();
        this.chartReady = new EventEmitter();
        this.chartReadyOneTime = new EventEmitter();
        this.chartError = new EventEmitter();
        this.chartErrorOneTime = new EventEmitter();
        this.mouseOver = new EventEmitter();
        this.mouseOverOneTime = new EventEmitter();
        this.mouseOut = new EventEmitter();
        this.mouseOutOneTime = new EventEmitter();
        this.regionClick = new EventEmitter();
        this.regionClickOneTime = new EventEmitter();
    }
    ngOnInit() {
        this.HTMLel = this.el.nativeElement.querySelector('div');
        this.data.component = this;
        this.options = this.data.options;
        this.init().then(() => {
            this.draw();
        });
    }
    init() {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.loaderService.load();
            this.recreateWrapper();
        });
    }
    recreateWrapper() {
        if (this.wrapper === undefined || this.wrapper.getChartType() !== this.data.chartType) {
            this.dataTable = new GoogleChartsDataTable(this.data);
            this.dataTable.dataTableChanged.subscribe((dt) => {
                this._draw();
            });
            // see dataTable in https://developers.google.com/chart/interactive/docs/reference#google.visualization.drawchart
            let temp = this.data;
            if (this.data.firstRowIsData) {
                temp = Object.assign(temp, this.data);
                temp.dataTable = this.dataTable.getDataTable();
            }
            this.wrapper = new google.visualization.ChartWrapper(temp);
            this.registerChartWrapperEvents();
            /* Calling draw even without data is the only way to pass the HTMl element
               when using the chart in a dashboard. Don't do this in all other cases:
               it breaks formatters with remote data source, hence the conditional. */
            if (temp.dataTable === undefined && temp.dataSourceUrl === undefined) {
                try {
                    this.wrapper.draw(this.HTMLel);
                }
                catch (err) { }
            }
        }
    }
    _draw() {
        return __awaiter(this, void 0, void 0, function* () {
            const dt = this.dataTable.getDataTable();
            if (dt === undefined) {
                return;
            }
            this.convertOptions();
            this.recreateWrapper();
            this.wrapper.setOptions(this.options);
            this.wrapper.setDataTable(dt);
            this.wrapper.draw(this.HTMLel);
        });
    }
    getDataTable() {
        return this.dataTable;
    }
    draw(value) {
        if (value === undefined) {
            value = this.data;
        }
        this.options = value.options;
        this.dataTable.init(value);
    }
    getSelectorBySeriesType(seriesType) {
        const selectors = {
            bars: 'bar#%s#%r',
            haxis: 'hAxis#0#label',
            line: 'point#%s#%r',
            legend: 'legendentry#%s',
            area: 'point#%s#%r'
        };
        const selector = selectors[seriesType];
        return selector;
    }
    /**
     * Given a column number, counts how many
     * columns have rol=="data". Those are mapped
     * one-to-one to the series array. When rol is not defined
     * a column of type number means a series column.
     * @param column to inspect
     */
    getSeriesByColumn(column) {
        let series = 0;
        const dataTable = this.wrapper.getDataTable();
        for (let i = column - 1; i >= 0; i--) {
            const role = dataTable.getColumnRole(i);
            const type = dataTable.getColumnType(i);
            if (role === 'data' || type === 'number') {
                series++;
            }
        }
        return series;
    }
    getBoundingBoxForItem(item) {
        let boundingBox = { top: 0, left: 0, width: 0, height: 0 };
        if (this.cli) {
            const column = item.column;
            const series = this.getSeriesByColumn(column);
            const row = item.row;
            let seriesType = this.options.seriesType;
            if (this.options.series && this.options.series[series] && this.options.series[series].type) {
                seriesType = this.options.series[series].type;
            }
            if (seriesType) {
                let selector = this.getSelectorBySeriesType(seriesType);
                if (selector) {
                    selector = selector.replace('%s', series + '').replace('%c', column + '').replace('%r', row + '');
                    const box = this.cli.getBoundingBox(selector);
                    if (box) {
                        boundingBox = box;
                    }
                }
            }
        }
        return boundingBox;
    }
    getValueAtPosition(position) {
        if (position.row == null) {
            return null;
        }
        const dataTable = this.wrapper.getDataTable();
        const value = dataTable.getValue(position.row, position.column);
        return value;
    }
    getColumnTypeAtPosition(position) {
        const dataTable = this.wrapper.getDataTable();
        const type = dataTable.getColumnType(position.column) || '';
        return type;
    }
    getColumnLabelAtPosition(position) {
        const dataTable = this.wrapper.getDataTable();
        const type = dataTable.getColumnLabel(position.column) || '';
        return type;
    }
    getHTMLTooltip() {
        const tooltipER = new ElementRef(this.el.nativeElement.querySelector('.google-visualization-tooltip'));
        return new ChartHTMLTooltip(tooltipER);
    }
    parseMouseEvent(item) {
        const chartType = this.wrapper.getChartType();
        let eventColumn = item.column;
        if (eventColumn == null) {
            switch (chartType) {
                case 'Timeline':
                    eventColumn = this.wrapper.getDataTable().getNumberOfColumns() === 3 ? 0 : 1;
                    break;
                default:
                    eventColumn = 0;
            }
        }
        const eventRow = item.row;
        const myItem = {
            row: eventRow,
            column: eventColumn
        };
        const event = {
            position: item,
            boundingBox: this.getBoundingBoxForItem(myItem),
            value: this.getValueAtPosition(myItem),
            columnType: this.getColumnTypeAtPosition(myItem),
            columnLabel: this.getColumnLabelAtPosition(myItem)
        };
        return event;
    }
    unregisterEvents() {
        google.visualization.events.removeAllListeners(this.wrapper.getChart());
        google.visualization.events.removeAllListeners(this.wrapper);
    }
    registerChartEvents() {
        const chart = this.wrapper.getChart();
        this.cli = chart.getChartLayoutInterface ? chart.getChartLayoutInterface() : null;
        if (this.mouseOver.observers.length > 0) {
            google.visualization.events.addListener(chart, 'onmouseover', (item) => {
                const event = this.parseMouseEvent(item);
                event.tooltip = this.getHTMLTooltip();
                this.mouseOver.emit(event);
            });
        }
        if (this.mouseOverOneTime.observers.length > 0) {
            google.visualization.events.addOneTimeListener(chart, 'onmouseover', (item) => {
                const event = this.parseMouseEvent(item);
                event.tooltip = this.getHTMLTooltip();
                this.mouseOverOneTime.emit(event);
            });
        }
        if (this.mouseOut.observers.length > 0) {
            google.visualization.events.addListener(chart, 'onmouseout', (item) => {
                const event = this.parseMouseEvent(item);
                this.mouseOut.emit(event);
            });
        }
        if (this.mouseOutOneTime.observers.length > 0) {
            google.visualization.events.addOneTimeListener(chart, 'onmouseout', (item) => {
                const event = this.parseMouseEvent(item);
                this.mouseOutOneTime.emit(event);
            });
        }
        if (this.data.chartType === 'GeoChart') {
            if (this.regionClick.observers.length > 0) {
                google.visualization.events.addListener(chart, 'regionClick', (item) => {
                    this.regionClick.emit(item);
                });
            }
            if (this.regionClickOneTime.observers.length > 0) {
                google.visualization.events.addOneTimeListener(chart, 'regionClick', (item) => {
                    this.regionClick.emit(item);
                });
            }
        }
    }
    registerChartWrapperEvents() {
        google.visualization.events.addListener(this.wrapper, 'ready', () => {
            this.chartReady.emit({ message: 'Chart ready' });
        });
        google.visualization.events.addOneTimeListener(this.wrapper, 'ready', () => {
            this.chartReadyOneTime.emit({ message: 'Chart ready (one time)' });
            this.registerChartEvents();
        });
        google.visualization.events.addListener(this.wrapper, 'error', (error) => {
            this.chartError.emit(error);
        });
        google.visualization.events.addOneTimeListener(this.wrapper, 'error', (error) => {
            this.chartErrorOneTime.emit(error);
        });
        this.addListener(this.wrapper, 'select', this.selectListener, this.chartSelect);
        this.addOneTimeListener(this.wrapper, 'select', this.selectListener, this.chartSelectOneTime);
    }
    addListener(source, eventType, listenerFn, evEmitter) {
        google.visualization.events.addListener(source, eventType, () => {
            evEmitter.emit(listenerFn());
        });
    }
    addOneTimeListener(source, eventType, listenerFn, evEmitter) {
        google.visualization.events.addOneTimeListener(source, eventType, () => {
            evEmitter.emit(listenerFn());
        });
    }
    convertOptions() {
        try {
            this.options = google.charts[this.data.chartType].convertOptions(this.options);
        }
        catch (error) {
            return;
        }
    }
};
GoogleChartComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: GoogleChartsLoaderService }
];
__decorate([
    Input()
], GoogleChartComponent.prototype, "data", void 0);
__decorate([
    Output()
], GoogleChartComponent.prototype, "chartReady", void 0);
__decorate([
    Output()
], GoogleChartComponent.prototype, "chartReadyOneTime", void 0);
__decorate([
    Output()
], GoogleChartComponent.prototype, "chartError", void 0);
__decorate([
    Output()
], GoogleChartComponent.prototype, "chartErrorOneTime", void 0);
__decorate([
    Output()
], GoogleChartComponent.prototype, "chartSelect", void 0);
__decorate([
    Output()
], GoogleChartComponent.prototype, "chartSelectOneTime", void 0);
__decorate([
    Output()
], GoogleChartComponent.prototype, "mouseOver", void 0);
__decorate([
    Output()
], GoogleChartComponent.prototype, "mouseOverOneTime", void 0);
__decorate([
    Output()
], GoogleChartComponent.prototype, "mouseOut", void 0);
__decorate([
    Output()
], GoogleChartComponent.prototype, "mouseOutOneTime", void 0);
__decorate([
    Output()
], GoogleChartComponent.prototype, "regionClick", void 0);
__decorate([
    Output()
], GoogleChartComponent.prototype, "regionClickOneTime", void 0);
GoogleChartComponent = __decorate([
    Component({
        selector: 'google-chart',
        template: '<div></div>'
    })
], GoogleChartComponent);
export { GoogleChartComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29vZ2xlLWNoYXJ0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25nMi1nb29nbGUtY2hhcnRzLyIsInNvdXJjZXMiOlsibGliL2dvb2dsZS1jaGFydC9nb29nbGUtY2hhcnQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFFQSxPQUFPLEVBQ0wsU0FBUyxFQUNULFVBQVUsRUFDVixNQUFNLEVBQ04sS0FBSyxFQUNMLE1BQU0sRUFDTixZQUFZLEVBQ2IsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDNUUsT0FBTyxFQUFFLHFCQUFxQixFQUFrQyxNQUFNLDRCQUE0QixDQUFDO0FBV25HLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBY3hELElBQWEsb0JBQW9CLEdBQWpDLE1BQWEsb0JBQW9CO0lBOEIvQixZQUEyQixFQUFjLEVBQ3RCLGFBQXdDO1FBRGhDLE9BQUUsR0FBRixFQUFFLENBQVk7UUF3UmpDLHNCQUFpQixHQUFHLENBQUMsSUFBdUIsRUFBRSxFQUFFO1lBQ3RELE1BQU0sS0FBSyxHQUF3QixJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBd0IsQ0FBQztZQUNyRixLQUFLLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUN0QyxPQUFPLEtBQUssQ0FBQztRQUNmLENBQUMsQ0FBQTtRQUVPLHFCQUFnQixHQUFHLENBQUMsSUFBdUIsRUFBRSxFQUFFO1lBQ3JELE1BQU0sS0FBSyxHQUF1QixJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBdUIsQ0FBQztZQUNuRixPQUFPLEtBQUssQ0FBQztRQUNmLENBQUMsQ0FBQTtRQUVPLG1CQUFjLEdBQUcsR0FBRyxFQUFFO1lBQzVCLE1BQU0sS0FBSyxHQUFxQjtnQkFDOUIsT0FBTyxFQUFFLFFBQVE7Z0JBQ2pCLEdBQUcsRUFBRSxJQUFJO2dCQUNU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OytEQUF5RDtBQUV4RDtJQUFULE1BQU0sRUFBRTt5REFBb0Q7QUFDbkQ7SUFBVCxNQUFNLEVBQUU7Z0VBQTJEO0FBRTFEO0lBQVQsTUFBTSxFQUFFO3VEQUFxRDtBQUNwRDtJQUFULE1BQU0sRUFBRTs4REFBNEQ7QUFFM0Q7SUFBVCxNQUFNLEVBQUU7c0RBQW1EO0FBQ2xEO0lBQVQsTUFBTSxFQUFFOzZEQUEwRDtBQUV6RDtJQUFULE1BQU0sRUFBRTt5REFBb0Q7QUFDbkQ7SUFBVCxNQUFNLEVBQUU7Z0VBQTJEO0FBcEJ6RCxvQkFBb0I7SUFKaEMsU0FBUyxDQUFDO1FBQ1QsUUFBUSxFQUFFLGNBQWM7UUFDeEIsUUFBUSxFQUFFLGFBQWE7S0FDeEIsQ0FBQztHQUNXLG9CQUFvQixDQWlYaEM7U0FqWFksb0JBQW9CIiwic291cmNlc0NvbnRlbnQiOlsiZGVjbGFyZSB2YXIgZ29vZ2xlOiBhbnk7XG5cbmltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgRWxlbWVudFJlZixcbiAgT25Jbml0LFxuICBJbnB1dCxcbiAgT3V0cHV0LFxuICBFdmVudEVtaXR0ZXJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IEdvb2dsZUNoYXJ0c0xvYWRlclNlcnZpY2UgfSBmcm9tICcuLi9nb29nbGUtY2hhcnRzLWxvYWRlci5zZXJ2aWNlJztcbmltcG9ydCB7IEdvb2dsZUNoYXJ0c0RhdGFUYWJsZSwgR29vZ2xlQ2hhcnRzRGF0YVRhYmxlSW50ZXJmYWNlIH0gZnJvbSAnLi4vZ29vZ2xlLWNoYXJ0cy1kYXRhdGFibGUnO1xuaW1wb3J0IHsgQ2hhcnRSZWFkeUV2ZW50IH0gZnJvbSAnLi9jaGFydC1yZWFkeS1ldmVudCc7XG5pbXBvcnQgeyBDaGFydEVycm9yRXZlbnQgfSBmcm9tICcuL2NoYXJ0LWVycm9yLWV2ZW50JztcbmltcG9ydCB7IENoYXJ0U2VsZWN0RXZlbnQgfSBmcm9tICcuL2NoYXJ0LXNlbGVjdC1ldmVudCc7XG5pbXBvcnQge1xuICBDaGFydE1vdXNlRXZlbnQsXG4gIENoYXJ0TW91c2VPdmVyRXZlbnQsXG4gIENoYXJ0TW91c2VPdXRFdmVudCxcbiAgQm91bmRpbmdCb3gsXG4gIERhdGFQb2ludFBvc2l0aW9uXG59IGZyb20gJy4vY2hhcnQtbW91c2UtZXZlbnQnO1xuaW1wb3J0IHsgQ2hhcnRIVE1MVG9vbHRpcCB9IGZyb20gJy4vY2hhcnQtaHRtbC10b29sdGlwJztcbmltcG9ydCB7IFJlZ2lvbkNsaWNrRXZlbnQgfSBmcm9tICcuL2dlb2NoYXJ0LWV2ZW50cyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgR29vZ2xlQ2hhcnRJbnRlcmZhY2UgZXh0ZW5kcyBHb29nbGVDaGFydHNEYXRhVGFibGVJbnRlcmZhY2Uge1xuICBjaGFydFR5cGU6IHN0cmluZztcbiAgb3B0aW9ucz86IGFueTtcblxuICBjb21wb25lbnQ/OiBHb29nbGVDaGFydENvbXBvbmVudDtcbn1cblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnZ29vZ2xlLWNoYXJ0JyxcbiAgdGVtcGxhdGU6ICc8ZGl2PjwvZGl2PicsXG59KVxuZXhwb3J0IGNsYXNzIEdvb2dsZUNoYXJ0Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcblxuICBASW5wdXQoKSBwdWJsaWMgZGF0YTogR29vZ2xlQ2hhcnRJbnRlcmZhY2U7XG5cbiAgQE91dHB1dCgpIHB1YmxpYyBjaGFydFJlYWR5OiBFdmVudEVtaXR0ZXI8Q2hhcnRSZWFkeUV2ZW50PjtcbiAgQE91dHB1dCgpIHB1YmxpYyBjaGFydFJlYWR5T25lVGltZTogRXZlbnRFbWl0dGVyPENoYXJ0UmVhZHlFdmVudD47XG5cbiAgQE91dHB1dCgpIHB1YmxpYyBjaGFydEVycm9yOiBFdmVudEVtaXR0ZXI8Q2hhcnRFcnJvckV2ZW50PjtcbiAgQE91dHB1dCgpIHB1YmxpYyBjaGFydEVycm9yT25lVGltZTogRXZlbnRFbWl0dGVyPENoYXJ0RXJyb3JFdmVudD47XG5cbiAgQE91dHB1dCgpIHB1YmxpYyBjaGFydFNlbGVjdDogRXZlbnRFbWl0dGVyPENoYXJ0U2VsZWN0RXZlbnQ+O1xuICBAT3V0cHV0KCkgcHVibGljIGNoYXJ0U2VsZWN0T25lVGltZTogRXZlbnRFbWl0dGVyPENoYXJ0U2VsZWN0RXZlbnQ+O1xuXG4gIEBPdXRwdXQoKSBwdWJsaWMgbW91c2VPdmVyOiBFdmVudEVtaXR0ZXI8Q2hhcnRNb3VzZU92ZXJFdmVudD47XG4gIEBPdXRwdXQoKSBwdWJsaWMgbW91c2VPdmVyT25lVGltZTogRXZlbnRFbWl0dGVyPENoYXJ0TW91c2VPdmVyRXZlbnQ+O1xuXG4gIEBPdXRwdXQoKSBwdWJsaWMgbW91c2VPdXQ6IEV2ZW50RW1pdHRlcjxDaGFydE1vdXNlT3V0RXZlbnQ+O1xuICBAT3V0cHV0KCkgcHVibGljIG1vdXNlT3V0T25lVGltZTogRXZlbnRFbWl0dGVyPENoYXJ0TW91c2VPdXRFdmVudD47XG5cbiAgQE91dHB1dCgpIHB1YmxpYyByZWdpb25DbGljazogRXZlbnRFbWl0dGVyPFJlZ2lvbkNsaWNrRXZlbnQ+O1xuICBAT3V0cHV0KCkgcHVibGljIHJlZ2lvbkNsaWNrT25lVGltZTogRXZlbnRFbWl0dGVyPFJlZ2lvbkNsaWNrRXZlbnQ+O1xuXG4gIHB1YmxpYyB3cmFwcGVyOiBhbnk7XG4gIHByaXZhdGUgY2xpOiBhbnk7XG4gIHByaXZhdGUgb3B0aW9uczogYW55O1xuXG4gIHByaXZhdGUgSFRNTGVsOiBIVE1MRWxlbWVudDtcbiAgcHJpdmF0ZSBsb2FkZXJTZXJ2aWNlOiBHb29nbGVDaGFydHNMb2FkZXJTZXJ2aWNlO1xuICBwcml2YXRlIGRhdGFUYWJsZTogR29vZ2xlQ2hhcnRzRGF0YVRhYmxlO1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3Rvcihwcml2YXRlIGVsOiBFbGVtZW50UmVmLFxuICAgICAgICAgICAgICAgICAgICAgbG9hZGVyU2VydmljZTogR29vZ2xlQ2hhcnRzTG9hZGVyU2VydmljZSkge1xuICAgIHRoaXMubG9hZGVyU2VydmljZSA9IGxvYWRlclNlcnZpY2U7XG4gICAgdGhpcy5jaGFydFNlbGVjdCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICB0aGlzLmNoYXJ0U2VsZWN0T25lVGltZSA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICB0aGlzLmNoYXJ0UmVhZHkgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgdGhpcy5jaGFydFJlYWR5T25lVGltZSA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICB0aGlzLmNoYXJ0RXJyb3IgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgdGhpcy5jaGFydEVycm9yT25lVGltZSA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICB0aGlzLm1vdXNlT3ZlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICB0aGlzLm1vdXNlT3Zlck9uZVRpbWUgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgdGhpcy5tb3VzZU91dCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICB0aGlzLm1vdXNlT3V0T25lVGltZSA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICB0aGlzLnJlZ2lvbkNsaWNrID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgIHRoaXMucmVnaW9uQ2xpY2tPbmVUaW1lID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICB9XG5cbiAgcHVibGljIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIHRoaXMuSFRNTGVsID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ2RpdicpO1xuICAgIHRoaXMuZGF0YS5jb21wb25lbnQgPSB0aGlzO1xuICAgIHRoaXMub3B0aW9ucyA9IHRoaXMuZGF0YS5vcHRpb25zO1xuXG4gICAgdGhpcy5pbml0KCkudGhlbigoKSA9PiB7XG4gICAgICB0aGlzLmRyYXcoKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBpbml0KCkge1xuICAgIGF3YWl0IHRoaXMubG9hZGVyU2VydmljZS5sb2FkKCk7XG4gICAgdGhpcy5yZWNyZWF0ZVdyYXBwZXIoKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVjcmVhdGVXcmFwcGVyKCkge1xuICAgIGlmICh0aGlzLndyYXBwZXIgPT09IHVuZGVmaW5lZCB8fCB0aGlzLndyYXBwZXIuZ2V0Q2hhcnRUeXBlKCkgIT09IHRoaXMuZGF0YS5jaGFydFR5cGUpIHtcbiAgICAgIHRoaXMuZGF0YVRhYmxlID0gbmV3IEdvb2dsZUNoYXJ0c0RhdGFUYWJsZSh0aGlzLmRhdGEpO1xuICAgICAgdGhpcy5kYXRhVGFibGUuZGF0YVRhYmxlQ2hhbmdlZC5zdWJzY3JpYmUoKGR0OiBhbnkpID0+IHtcbiAgICAgICAgdGhpcy5fZHJhdygpO1xuICAgICAgfSk7XG5cbiAgICAgIC8vIHNlZSBkYXRhVGFibGUgaW4gaHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vY2hhcnQvaW50ZXJhY3RpdmUvZG9jcy9yZWZlcmVuY2UjZ29vZ2xlLnZpc3VhbGl6YXRpb24uZHJhd2NoYXJ0XG4gICAgICBsZXQgdGVtcDogR29vZ2xlQ2hhcnRJbnRlcmZhY2UgPSB0aGlzLmRhdGE7XG4gICAgICBpZiAodGhpcy5kYXRhLmZpcnN0Um93SXNEYXRhKSB7XG4gICAgICAgIHRlbXAgPSBPYmplY3QuYXNzaWduKHRlbXAsIHRoaXMuZGF0YSk7XG4gICAgICAgIHRlbXAuZGF0YVRhYmxlID0gdGhpcy5kYXRhVGFibGUuZ2V0RGF0YVRhYmxlKCk7XG4gICAgICB9XG4gICAgICB0aGlzLndyYXBwZXIgPSBuZXcgZ29vZ2xlLnZpc3VhbGl6YXRpb24uQ2hhcnRXcmFwcGVyKHRlbXApO1xuICAgICAgdGhpcy5yZWdpc3RlckNoYXJ0V3JhcHBlckV2ZW50cygpO1xuXG4gICAgICAvKiBDYWxsaW5nIGRyYXcgZXZlbiB3aXRob3V0IGRhdGEgaXMgdGhlIG9ubHkgd2F5IHRvIHBhc3MgdGhlIEhUTWwgZWxlbWVudFxuICAgICAgICAgd2hlbiB1c2luZyB0aGUgY2hhcnQgaW4gYSBkYXNoYm9hcmQuIERvbid0IGRvIHRoaXMgaW4gYWxsIG90aGVyIGNhc2VzOlxuICAgICAgICAgaXQgYnJlYWtzIGZvcm1hdHRlcnMgd2l0aCByZW1vdGUgZGF0YSBzb3VyY2UsIGhlbmNlIHRoZSBjb25kaXRpb25hbC4gKi9cbiAgICAgIGlmICh0ZW1wLmRhdGFUYWJsZSA9PT0gdW5kZWZpbmVkICYmIHRlbXAuZGF0YVNvdXJjZVVybCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgdGhpcy53cmFwcGVyLmRyYXcodGhpcy5IVE1MZWwpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHt9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBfZHJhdygpIHtcbiAgICBjb25zdCBkdCA9IHRoaXMuZGF0YVRhYmxlLmdldERhdGFUYWJsZSgpO1xuICAgIGlmIChkdCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuY29udmVydE9wdGlvbnMoKTtcbiAgICB0aGlzLnJlY3JlYXRlV3JhcHBlcigpO1xuICAgIHRoaXMud3JhcHBlci5zZXRPcHRpb25zKHRoaXMub3B0aW9ucyk7XG4gICAgdGhpcy53cmFwcGVyLnNldERhdGFUYWJsZShkdCk7XG4gICAgdGhpcy53cmFwcGVyLmRyYXcodGhpcy5IVE1MZWwpO1xuICB9XG5cbiAgcHVibGljIGdldERhdGFUYWJsZSgpOiBHb29nbGVDaGFydHNEYXRhVGFibGUge1xuICAgIHJldHVybiB0aGlzLmRhdGFUYWJsZTtcbiAgfVxuXG4gIHB1YmxpYyBkcmF3KHZhbHVlPzogR29vZ2xlQ2hhcnRJbnRlcmZhY2UpIHtcbiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdmFsdWUgPSB0aGlzLmRhdGE7XG4gICAgfVxuICAgIHRoaXMub3B0aW9ucyA9IHZhbHVlLm9wdGlvbnM7XG4gICAgdGhpcy5kYXRhVGFibGUuaW5pdCh2YWx1ZSk7XG4gIH1cblxuICBwcml2YXRlIGdldFNlbGVjdG9yQnlTZXJpZXNUeXBlKHNlcmllc1R5cGU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3Qgc2VsZWN0b3JzOiBhbnkgPSB7XG4gICAgICBiYXJzIDogJ2JhciMlcyMlcicsXG4gICAgICBoYXhpcyA6ICdoQXhpcyMwI2xhYmVsJyxcbiAgICAgIGxpbmU6ICdwb2ludCMlcyMlcicsXG4gICAgICBsZWdlbmQgOiAnbGVnZW5kZW50cnkjJXMnLFxuICAgICAgYXJlYTogJ3BvaW50IyVzIyVyJ1xuICAgIH07XG5cbiAgICBjb25zdCBzZWxlY3Rvcjogc3RyaW5nID0gc2VsZWN0b3JzW3Nlcmllc1R5cGVdO1xuXG4gICAgcmV0dXJuIHNlbGVjdG9yO1xuICB9XG5cbiAvKipcbiAgKiBHaXZlbiBhIGNvbHVtbiBudW1iZXIsIGNvdW50cyBob3cgbWFueVxuICAqIGNvbHVtbnMgaGF2ZSByb2w9PVwiZGF0YVwiLiBUaG9zZSBhcmUgbWFwcGVkXG4gICogb25lLXRvLW9uZSB0byB0aGUgc2VyaWVzIGFycmF5LiBXaGVuIHJvbCBpcyBub3QgZGVmaW5lZFxuICAqIGEgY29sdW1uIG9mIHR5cGUgbnVtYmVyIG1lYW5zIGEgc2VyaWVzIGNvbHVtbi5cbiAgKiBAcGFyYW0gY29sdW1uIHRvIGluc3BlY3RcbiAgKi9cbiAgcHJpdmF0ZSBnZXRTZXJpZXNCeUNvbHVtbihjb2x1bW46IG51bWJlcik6IG51bWJlciAge1xuICAgIGxldCBzZXJpZXMgPSAwO1xuICAgIGNvbnN0IGRhdGFUYWJsZSA9IHRoaXMud3JhcHBlci5nZXREYXRhVGFibGUoKTtcbiAgICBmb3IgKGxldCBpID0gY29sdW1uIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgIGNvbnN0IHJvbGUgPSBkYXRhVGFibGUuZ2V0Q29sdW1uUm9sZShpKTtcbiAgICAgIGNvbnN0IHR5cGUgPSBkYXRhVGFibGUuZ2V0Q29sdW1uVHlwZShpKTtcbiAgICAgIGlmIChyb2xlID09PSAnZGF0YScgfHwgdHlwZSA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgc2VyaWVzKys7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBzZXJpZXM7XG4gIH1cblxuICBwcml2YXRlIGdldEJvdW5kaW5nQm94Rm9ySXRlbShpdGVtOiBEYXRhUG9pbnRQb3NpdGlvbik6IEJvdW5kaW5nQm94IHtcbiAgICBsZXQgYm91bmRpbmdCb3ggPSB7dG9wOiAwLCBsZWZ0OiAwLCB3aWR0aDogMCwgaGVpZ2h0OiAwfTtcbiAgICBpZiAodGhpcy5jbGkpIHtcbiAgICAgIGNvbnN0IGNvbHVtbiA9IGl0ZW0uY29sdW1uO1xuICAgICAgY29uc3Qgc2VyaWVzID0gdGhpcy5nZXRTZXJpZXNCeUNvbHVtbihjb2x1bW4pO1xuICAgICAgY29uc3Qgcm93ID0gaXRlbS5yb3c7XG4gICAgICBsZXQgc2VyaWVzVHlwZSA9IHRoaXMub3B0aW9ucy5zZXJpZXNUeXBlO1xuICAgICAgaWYgKHRoaXMub3B0aW9ucy5zZXJpZXMgJiYgdGhpcy5vcHRpb25zLnNlcmllc1tzZXJpZXNdICYmIHRoaXMub3B0aW9ucy5zZXJpZXNbc2VyaWVzXS50eXBlKSB7XG4gICAgICAgIHNlcmllc1R5cGUgPSB0aGlzLm9wdGlvbnMuc2VyaWVzW3Nlcmllc10udHlwZTtcbiAgICAgIH1cbiAgICAgIGlmIChzZXJpZXNUeXBlKSB7XG4gICAgICAgIGxldCBzZWxlY3RvciA9IHRoaXMuZ2V0U2VsZWN0b3JCeVNlcmllc1R5cGUoc2VyaWVzVHlwZSk7XG4gICAgICAgIGlmIChzZWxlY3Rvcikge1xuICAgICAgICAgICAgIHNlbGVjdG9yID0gc2VsZWN0b3IucmVwbGFjZSgnJXMnLCBzZXJpZXMgKyAnJykucmVwbGFjZSgnJWMnLCBjb2x1bW4gKyAnJykucmVwbGFjZSgnJXInLCByb3cgKyAnJyk7XG4gICAgICAgICAgICAgY29uc3QgYm94ID0gdGhpcy5jbGkuZ2V0Qm91bmRpbmdCb3goc2VsZWN0b3IpO1xuICAgICAgICAgICAgIGlmIChib3gpIHtcbiAgICAgICAgICAgICAgYm91bmRpbmdCb3ggPSBib3g7XG4gICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGJvdW5kaW5nQm94O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRWYWx1ZUF0UG9zaXRpb24ocG9zaXRpb246IERhdGFQb2ludFBvc2l0aW9uKTogYW55IHtcbiAgICBpZiAocG9zaXRpb24ucm93ID09IG51bGwpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBjb25zdCBkYXRhVGFibGUgPSB0aGlzLndyYXBwZXIuZ2V0RGF0YVRhYmxlKCk7XG4gICAgY29uc3QgdmFsdWUgPSBkYXRhVGFibGUuZ2V0VmFsdWUocG9zaXRpb24ucm93LCBwb3NpdGlvbi5jb2x1bW4pO1xuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q29sdW1uVHlwZUF0UG9zaXRpb24ocG9zaXRpb246IERhdGFQb2ludFBvc2l0aW9uKTogc3RyaW5nIHtcbiAgICAgIGNvbnN0IGRhdGFUYWJsZSA9IHRoaXMud3JhcHBlci5nZXREYXRhVGFibGUoKTtcbiAgICAgIGNvbnN0IHR5cGUgPSBkYXRhVGFibGUuZ2V0Q29sdW1uVHlwZShwb3NpdGlvbi5jb2x1bW4pIHx8ICcnO1xuICAgICAgcmV0dXJuIHR5cGU7XG4gIH1cblxuICBwcml2YXRlIGdldENvbHVtbkxhYmVsQXRQb3NpdGlvbihwb3NpdGlvbjogRGF0YVBvaW50UG9zaXRpb24pOiBzdHJpbmcge1xuICAgICAgY29uc3QgZGF0YVRhYmxlID0gdGhpcy53cmFwcGVyLmdldERhdGFUYWJsZSgpO1xuICAgICAgY29uc3QgdHlwZSA9IGRhdGFUYWJsZS5nZXRDb2x1bW5MYWJlbChwb3NpdGlvbi5jb2x1bW4pIHx8ICcnO1xuICAgICAgcmV0dXJuIHR5cGU7XG4gIH1cblxuICBwcml2YXRlIGdldEhUTUxUb29sdGlwKCk6IENoYXJ0SFRNTFRvb2x0aXAge1xuICAgIGNvbnN0IHRvb2x0aXBFUiA9IG5ldyBFbGVtZW50UmVmKHRoaXMuZWwubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKCcuZ29vZ2xlLXZpc3VhbGl6YXRpb24tdG9vbHRpcCcpKTtcbiAgICByZXR1cm4gbmV3IENoYXJ0SFRNTFRvb2x0aXAodG9vbHRpcEVSKTtcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VNb3VzZUV2ZW50KGl0ZW06IERhdGFQb2ludFBvc2l0aW9uKTogQ2hhcnRNb3VzZUV2ZW50IHtcbiAgICBjb25zdCBjaGFydFR5cGUgPSB0aGlzLndyYXBwZXIuZ2V0Q2hhcnRUeXBlKCk7XG4gICAgbGV0IGV2ZW50Q29sdW1uID0gaXRlbS5jb2x1bW47XG4gICAgaWYgKGV2ZW50Q29sdW1uID09IG51bGwpIHtcbiAgICAgIHN3aXRjaCAoY2hhcnRUeXBlKSB7XG4gICAgICAgIGNhc2UgJ1RpbWVsaW5lJzpcbiAgICAgICAgICBldmVudENvbHVtbiA9IHRoaXMud3JhcHBlci5nZXREYXRhVGFibGUoKS5nZXROdW1iZXJPZkNvbHVtbnMoKSA9PT0gMyA/IDAgOiAxO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIGV2ZW50Q29sdW1uID0gMDtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgZXZlbnRSb3cgPSBpdGVtLnJvdztcbiAgICBjb25zdCBteUl0ZW0gPSB7XG4gICAgICByb3c6IGV2ZW50Um93LFxuICAgICAgY29sdW1uOiBldmVudENvbHVtblxuICAgIH07XG4gICAgY29uc3QgZXZlbnQgPSB7XG4gICAgICBwb3NpdGlvbjogaXRlbSxcbiAgICAgIGJvdW5kaW5nQm94OiB0aGlzLmdldEJvdW5kaW5nQm94Rm9ySXRlbShteUl0ZW0pLFxuICAgICAgdmFsdWU6IHRoaXMuZ2V0VmFsdWVBdFBvc2l0aW9uKG15SXRlbSksXG4gICAgICBjb2x1bW5UeXBlOiB0aGlzLmdldENvbHVtblR5cGVBdFBvc2l0aW9uKG15SXRlbSksXG4gICAgICBjb2x1bW5MYWJlbDogdGhpcy5nZXRDb2x1bW5MYWJlbEF0UG9zaXRpb24obXlJdGVtKVxuICAgIH07XG4gICAgcmV0dXJuIGV2ZW50O1xuICB9XG5cbiAgcHJpdmF0ZSB1bnJlZ2lzdGVyRXZlbnRzKCk6IHZvaWQge1xuICAgIGdvb2dsZS52aXN1YWxpemF0aW9uLmV2ZW50cy5yZW1vdmVBbGxMaXN0ZW5lcnModGhpcy53cmFwcGVyLmdldENoYXJ0KCkpO1xuICAgIGdvb2dsZS52aXN1YWxpemF0aW9uLmV2ZW50cy5yZW1vdmVBbGxMaXN0ZW5lcnModGhpcy53cmFwcGVyKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVnaXN0ZXJDaGFydEV2ZW50cygpOiB2b2lkIHtcbiAgICBjb25zdCBjaGFydCA9IHRoaXMud3JhcHBlci5nZXRDaGFydCgpO1xuICAgIHRoaXMuY2xpID0gY2hhcnQuZ2V0Q2hhcnRMYXlvdXRJbnRlcmZhY2UgPyBjaGFydC5nZXRDaGFydExheW91dEludGVyZmFjZSgpIDogbnVsbDtcbiAgICBpZiAodGhpcy5tb3VzZU92ZXIub2JzZXJ2ZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgIGdvb2dsZS52aXN1YWxpemF0aW9uLmV2ZW50cy5hZGRMaXN0ZW5lcihjaGFydCwgJ29ubW91c2VvdmVyJywgKGl0ZW06IERhdGFQb2ludFBvc2l0aW9uKSA9PiB7XG4gICAgICAgIGNvbnN0IGV2ZW50OiBDaGFydE1vdXNlT3ZlckV2ZW50ID0gdGhpcy5wYXJzZU1vdXNlRXZlbnQoaXRlbSkgYXMgQ2hhcnRNb3VzZU92ZXJFdmVudDtcbiAgICAgICAgZXZlbnQudG9vbHRpcCA9IHRoaXMuZ2V0SFRNTFRvb2x0aXAoKTtcbiAgICAgICAgdGhpcy5tb3VzZU92ZXIuZW1pdChldmVudCk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgaWYgKHRoaXMubW91c2VPdmVyT25lVGltZS5vYnNlcnZlcnMubGVuZ3RoID4gMCkge1xuICAgICAgZ29vZ2xlLnZpc3VhbGl6YXRpb24uZXZlbnRzLmFkZE9uZVRpbWVMaXN0ZW5lcihjaGFydCwgJ29ubW91c2VvdmVyJywgKGl0ZW06IERhdGFQb2ludFBvc2l0aW9uKSA9PiB7XG4gICAgICAgIGNvbnN0IGV2ZW50OiBDaGFydE1vdXNlT3ZlckV2ZW50ID0gdGhpcy5wYXJzZU1vdXNlRXZlbnQoaXRlbSkgYXMgQ2hhcnRNb3VzZU92ZXJFdmVudDtcbiAgICAgICAgZXZlbnQudG9vbHRpcCA9IHRoaXMuZ2V0SFRNTFRvb2x0aXAoKTtcbiAgICAgICAgdGhpcy5tb3VzZU92ZXJPbmVUaW1lLmVtaXQoZXZlbnQpO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMubW91c2VPdXQub2JzZXJ2ZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgIGdvb2dsZS52aXN1YWxpemF0aW9uLmV2ZW50cy5hZGRMaXN0ZW5lcihjaGFydCwgJ29ubW91c2VvdXQnLCAoaXRlbTogRGF0YVBvaW50UG9zaXRpb24pID0+IHtcbiAgICAgICAgY29uc3QgZXZlbnQ6IENoYXJ0TW91c2VPdXRFdmVudCA9IHRoaXMucGFyc2VNb3VzZUV2ZW50KGl0ZW0pIGFzIENoYXJ0TW91c2VPdXRFdmVudDtcbiAgICAgICAgdGhpcy5tb3VzZU91dC5lbWl0KGV2ZW50KTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmICh0aGlzLm1vdXNlT3V0T25lVGltZS5vYnNlcnZlcnMubGVuZ3RoID4gMCkge1xuICAgICAgZ29vZ2xlLnZpc3VhbGl6YXRpb24uZXZlbnRzLmFkZE9uZVRpbWVMaXN0ZW5lcihjaGFydCwgJ29ubW91c2VvdXQnLCAoaXRlbTogRGF0YVBvaW50UG9zaXRpb24pID0+IHtcbiAgICAgICAgY29uc3QgZXZlbnQ6IENoYXJ0TW91c2VPdXRFdmVudCA9IHRoaXMucGFyc2VNb3VzZUV2ZW50KGl0ZW0pIGFzIENoYXJ0TW91c2VPdXRFdmVudDtcbiAgICAgICAgdGhpcy5tb3VzZU91dE9uZVRpbWUuZW1pdChldmVudCk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5kYXRhLmNoYXJ0VHlwZSA9PT0gJ0dlb0NoYXJ0Jykge1xuICAgICAgaWYgKHRoaXMucmVnaW9uQ2xpY2sub2JzZXJ2ZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgZ29vZ2xlLnZpc3VhbGl6YXRpb24uZXZlbnRzLmFkZExpc3RlbmVyKGNoYXJ0LCAncmVnaW9uQ2xpY2snLCAoaXRlbTogUmVnaW9uQ2xpY2tFdmVudCkgPT4ge1xuICAgICAgICAgIHRoaXMucmVnaW9uQ2xpY2suZW1pdChpdGVtKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5yZWdpb25DbGlja09uZVRpbWUub2JzZXJ2ZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgZ29vZ2xlLnZpc3VhbGl6YXRpb24uZXZlbnRzLmFkZE9uZVRpbWVMaXN0ZW5lcihjaGFydCwgJ3JlZ2lvbkNsaWNrJywgKGl0ZW06IFJlZ2lvbkNsaWNrRXZlbnQpID0+IHtcbiAgICAgICAgICB0aGlzLnJlZ2lvbkNsaWNrLmVtaXQoaXRlbSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVnaXN0ZXJDaGFydFdyYXBwZXJFdmVudHMoKTogdm9pZCB7XG4gICAgZ29vZ2xlLnZpc3VhbGl6YXRpb24uZXZlbnRzLmFkZExpc3RlbmVyKHRoaXMud3JhcHBlciwgJ3JlYWR5JywgKCkgPT4ge1xuICAgICAgdGhpcy5jaGFydFJlYWR5LmVtaXQoe21lc3NhZ2U6ICdDaGFydCByZWFkeSd9KTtcbiAgICB9KTtcblxuICAgIGdvb2dsZS52aXN1YWxpemF0aW9uLmV2ZW50cy5hZGRPbmVUaW1lTGlzdGVuZXIodGhpcy53cmFwcGVyLCAncmVhZHknLCAoKSA9PiB7XG4gICAgICB0aGlzLmNoYXJ0UmVhZHlPbmVUaW1lLmVtaXQoe21lc3NhZ2U6ICdDaGFydCByZWFkeSAob25lIHRpbWUpJ30pO1xuICAgICAgdGhpcy5yZWdpc3RlckNoYXJ0RXZlbnRzKCk7XG4gICAgfSk7XG5cbiAgICBnb29nbGUudmlzdWFsaXphdGlvbi5ldmVudHMuYWRkTGlzdGVuZXIodGhpcy53cmFwcGVyLCAnZXJyb3InLCAoZXJyb3I6IGFueSkgPT4ge1xuICAgICAgdGhpcy5jaGFydEVycm9yLmVtaXQoZXJyb3IgYXMgQ2hhcnRFcnJvckV2ZW50KTtcbiAgICB9KTtcblxuICAgIGdvb2dsZS52aXN1YWxpemF0aW9uLmV2ZW50cy5hZGRPbmVUaW1lTGlzdGVuZXIodGhpcy53cmFwcGVyLCAnZXJyb3InLCAoZXJyb3I6IGFueSkgPT4ge1xuICAgICAgdGhpcy5jaGFydEVycm9yT25lVGltZS5lbWl0KGVycm9yIGFzIENoYXJ0RXJyb3JFdmVudCk7XG4gICAgfSk7XG5cbiAgICB0aGlzLmFkZExpc3RlbmVyKHRoaXMud3JhcHBlciwgJ3NlbGVjdCcsIHRoaXMuc2VsZWN0TGlzdGVuZXIsIHRoaXMuY2hhcnRTZWxlY3QpO1xuICAgIHRoaXMuYWRkT25lVGltZUxpc3RlbmVyKHRoaXMud3JhcHBlciwgJ3NlbGVjdCcsIHRoaXMuc2VsZWN0TGlzdGVuZXIsIHRoaXMuY2hhcnRTZWxlY3RPbmVUaW1lKTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkTGlzdGVuZXIoc291cmNlOiBhbnksIGV2ZW50VHlwZTogc3RyaW5nLCBsaXN0ZW5lckZuOiBhbnksIGV2RW1pdHRlcjogRXZlbnRFbWl0dGVyPGFueT4pIHtcbiAgICBnb29nbGUudmlzdWFsaXphdGlvbi5ldmVudHMuYWRkTGlzdGVuZXIoc291cmNlLCBldmVudFR5cGUsICgpID0+IHtcbiAgICAgIGV2RW1pdHRlci5lbWl0KGxpc3RlbmVyRm4oKSk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGFkZE9uZVRpbWVMaXN0ZW5lcihzb3VyY2U6IGFueSwgZXZlbnRUeXBlOiBzdHJpbmcsIGxpc3RlbmVyRm46IGFueSwgZXZFbWl0dGVyOiBFdmVudEVtaXR0ZXI8YW55Pikge1xuICAgIGdvb2dsZS52aXN1YWxpemF0aW9uLmV2ZW50cy5hZGRPbmVUaW1lTGlzdGVuZXIoc291cmNlLCBldmVudFR5cGUsICgpID0+IHtcbiAgICAgIGV2RW1pdHRlci5lbWl0KGxpc3RlbmVyRm4oKSk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIG1vdXNlT3Zlckxpc3RlbmVyID0gKGl0ZW06IERhdGFQb2ludFBvc2l0aW9uKSA9PiB7XG4gICAgY29uc3QgZXZlbnQ6IENoYXJ0TW91c2VPdmVyRXZlbnQgPSB0aGlzLnBhcnNlTW91c2VFdmVudChpdGVtKSBhcyBDaGFydE1vdXNlT3ZlckV2ZW50O1xuICAgIGV2ZW50LnRvb2x0aXAgPSB0aGlzLmdldEhUTUxUb29sdGlwKCk7XG4gICAgcmV0dXJuIGV2ZW50O1xuICB9XG5cbiAgcHJpdmF0ZSBtb3VzZU91dExpc3RlbmVyID0gKGl0ZW06IERhdGFQb2ludFBvc2l0aW9uKSA9PiB7XG4gICAgY29uc3QgZXZlbnQ6IENoYXJ0TW91c2VPdXRFdmVudCA9IHRoaXMucGFyc2VNb3VzZUV2ZW50KGl0ZW0pIGFzIENoYXJ0TW91c2VPdXRFdmVudDtcbiAgICByZXR1cm4gZXZlbnQ7XG4gIH1cblxuICBwcml2YXRlIHNlbGVjdExpc3RlbmVyID0gKCkgPT4ge1xuICAgIGNvbnN0IGV2ZW50OiBDaGFydFNlbGVjdEV2ZW50ID0ge1xuICAgICAgbWVzc2FnZTogJ3NlbGVjdCcsXG4gICAgICByb3c6IG51bGwsXG4gICAgICBjb2x1bW46IG51bGwsXG4gICAgICBzZWxlY3RlZFJvd1ZhbHVlczogW10sXG4gICAgICBzZWxlY3RlZFJvd0Zvcm1hdHRlZFZhbHVlczogW10sXG4gICAgICBjb2x1bW5MYWJlbDogJydcbiAgICB9O1xuICAgIGNvbnN0IHMgPSB0aGlzLndyYXBwZXIudmlzdWFsaXphdGlvbi5nZXRTZWxlY3Rpb24oKTtcbiAgICBjb25zdCBncyA9IHNbcy5sZW5ndGggLSAxXTtcbiAgICBpZiAoIWdzKSB7XG4gICAgICBldmVudC5tZXNzYWdlID0gJ2Rlc2VsZWN0JztcbiAgICAgIHJldHVybiBldmVudDtcbiAgICB9XG4gICAgY29uc3Qgc2VsZWN0aW9uOiBEYXRhUG9pbnRQb3NpdGlvbiA9IGdzO1xuICAgIGlmIChncy5yb3cgIT0gbnVsbCkge1xuICAgICAgZXZlbnQucm93ID0gc2VsZWN0aW9uLnJvdztcblxuICAgICAgY29uc3Qgc2VsZWN0ZWRSb3dWYWx1ZXMgPSBbXTtcbiAgICAgIGNvbnN0IHNlbGVjdGVkUm93Rm9ybWF0dGVkVmFsdWVzID0gW107XG4gICAgICBjb25zdCBkYXRhVGFibGUgPSB0aGlzLndyYXBwZXIuZ2V0RGF0YVRhYmxlKCk7XG4gICAgICBjb25zdCBudW1iZXJPZkNvbHVtbnMgPSBkYXRhVGFibGUuZ2V0TnVtYmVyT2ZDb2x1bW5zKCk7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bWJlck9mQ29sdW1uczsgaSsrKSB7XG4gICAgICAgIHNlbGVjdGVkUm93VmFsdWVzLnB1c2goZGF0YVRhYmxlLmdldFZhbHVlKHNlbGVjdGlvbi5yb3csIGkpKTtcbiAgICAgICAgc2VsZWN0ZWRSb3dGb3JtYXR0ZWRWYWx1ZXMucHVzaChkYXRhVGFibGUuZ2V0Rm9ybWF0dGVkVmFsdWUoc2VsZWN0aW9uLnJvdywgaSkpO1xuICAgICAgfVxuICAgICAgZXZlbnQuc2VsZWN0ZWRSb3dWYWx1ZXMgPSBzZWxlY3RlZFJvd1ZhbHVlcztcbiAgICAgIGV2ZW50LnNlbGVjdGVkUm93Rm9ybWF0dGVkVmFsdWVzID0gc2VsZWN0ZWRSb3dGb3JtYXR0ZWRWYWx1ZXM7XG4gICAgfVxuICAgIGlmIChzZWxlY3Rpb24uY29sdW1uICE9IG51bGwpIHtcbiAgICAgIGV2ZW50LmNvbHVtbiA9IHNlbGVjdGlvbi5jb2x1bW47XG4gICAgICBldmVudC5jb2x1bW5MYWJlbCA9IHRoaXMuZ2V0Q29sdW1uTGFiZWxBdFBvc2l0aW9uKHNlbGVjdGlvbik7XG4gICAgfVxuICAgIGlmIChncy5uYW1lKSB7XG4gICAgICBldmVudC5jb2x1bW5MYWJlbCA9IGdzLm5hbWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIGV2ZW50O1xuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0T3B0aW9ucygpIHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5vcHRpb25zID0gZ29vZ2xlLmNoYXJ0c1t0aGlzLmRhdGEuY2hhcnRUeXBlXS5jb252ZXJ0T3B0aW9ucyh0aGlzLm9wdGlvbnMpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG59XG4iXX0=