import { __decorate } from "tslib";
import { EventEmitter, Output, } from '@angular/core';
export class GoogleChartsDataTable {
    constructor(opt) {
        this.opt = opt;
        this.dataTableChanged = new EventEmitter();
        if (opt) {
            this._setDataTable(opt.dataTable, opt.firstRowIsData);
        }
    }
    send() {
        if (this.query === undefined) {
            return;
        }
        this.query.send((queryResponse) => {
            this.setDataTable(queryResponse.getDataTable());
            if (this.opt.queryCallback) {
                this.opt.queryCallback(queryResponse);
            }
        });
    }
    init(opt) {
        if (opt) {
            this.opt = opt;
        }
        if (this.tid !== undefined) {
            // doesn't work, see https://github.com/google/google-visualization-issues/issues/2381
            // this.query.abort();
            window.clearInterval(this.tid);
            this.tid = undefined;
        }
        if (this.opt.dataSourceUrl) {
            this.query = new google.visualization.Query(this.opt.dataSourceUrl);
            if (this.opt.query) {
                this.query.setQuery(this.opt.query);
            }
            if (this.opt.timeout !== undefined) {
                this.query.setTimeout(this.opt.timeout);
            }
            if (this.opt.refreshInterval) {
                // this.query.setRefreshInterval(this.opt.refreshInterval);
                this.tid = window.setInterval(() => {
                    this.send();
                }, this.opt.refreshInterval * 1000);
            }
            this.send();
        }
        else {
            this.setDataTable(this.opt.dataTable);
        }
    }
    /**
     * @returns Underlying google.visualization.DataTable
     */
    getDataTable() {
        return this.dataTable;
    }
    setDataTable(dt, firstRowIsData) {
        if (firstRowIsData === undefined) {
            firstRowIsData = this.opt.firstRowIsData;
        }
        this._setDataTable(dt, firstRowIsData);
        this.dataTableChanged.emit(this.dataTable);
    }
    _setDataTable(dt, firstRowIsData) {
        if (Array.isArray(dt)) {
            dt = google.visualization.arrayToDataTable(dt, firstRowIsData);
        }
        this.dataTable = dt;
        this.reformat();
    }
    /**
     * Applies formatters to data columns, if defined
     */
    reformat() {
        const dt = this.dataTable;
        if (dt === undefined) {
            return;
        }
        if (this.opt.formatters === undefined) {
            return;
        }
        for (const formatterConfig of this.opt.formatters) {
            let formatter;
            if (formatterConfig.type === 'PatternFormat') {
                const fmtOptions = formatterConfig.options;
                formatter = new google.visualization.PatternFormat(fmtOptions.pattern);
                formatter.format(dt, formatterConfig.columns, fmtOptions.dstColumnIndex);
                continue;
            }
            const formatterConstructor = google.visualization[formatterConfig.type];
            const formatterOptions = formatterConfig.options;
            formatter = new formatterConstructor(formatterOptions);
            if (formatterConfig.type === 'ColorFormat' && formatterOptions) {
                const fmtOptions = formatterOptions;
                for (const range of fmtOptions.ranges) {
                    if (typeof (range.fromBgColor) !== 'undefined'
                        && typeof (range.toBgColor) !== 'undefined') {
                        formatter.addGradientRange(range.from, range.to, range.color, range.fromBgColor, range.toBgColor);
                    }
                    else {
                        formatter.addRange(range.from, range.to, range.color, range.bgcolor);
                    }
                }
            }
            for (const col of formatterConfig.columns) {
                formatter.format(dt, col);
            }
        }
    }
}
__decorate([
    Output()
], GoogleChartsDataTable.prototype, "dataTableChanged", void 0);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29vZ2xlLWNoYXJ0cy1kYXRhdGFibGUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZzItZ29vZ2xlLWNoYXJ0cy8iLCJzb3VyY2VzIjpbImxpYi9nb29nbGUtY2hhcnRzLWRhdGF0YWJsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBc0ZBLE9BQU8sRUFDTCxZQUFZLEVBQ1osTUFBTSxHQUNQLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE1BQU0sT0FBTyxxQkFBcUI7SUFPaEMsWUFBb0IsR0FBbUM7UUFBbkMsUUFBRyxHQUFILEdBQUcsQ0FBZ0M7UUFGN0MscUJBQWdCLEdBQXNCLElBQUksWUFBWSxFQUFFLENBQUM7UUFHakUsSUFBSSxHQUFHLEVBQUU7WUFDUCxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1NBQ3ZEO0lBQ0gsQ0FBQztJQUVPLElBQUk7UUFDVixJQUFJLElBQUksQ0FBQyxLQUFLLEtBQUssU0FBUyxFQUFFO1lBQzVCLE9BQU87U0FDUjtRQUNELElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsYUFBa0IsRUFBRSxFQUFFO1lBQ3JDLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUM7WUFDaEQsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRTtnQkFDMUIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLENBQUM7YUFDdkM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTSxJQUFJLENBQUMsR0FBb0M7UUFDOUMsSUFBSSxHQUFHLEVBQUU7WUFDUCxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztTQUNoQjtRQUVELElBQUksSUFBSSxDQUFDLEdBQUcsS0FBSyxTQUFTLEVBQUU7WUFDMUIsc0ZBQXNGO1lBQ3RGLHNCQUFzQjtZQUN0QixNQUFNLENBQUMsYUFBYSxD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cG9ydCBpbnRlcmZhY2UgQXJyb3dGb3JtYXRJbnRlcmZhY2Uge1xuICBiYXNlOiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQmFyRm9ybWF0SW50ZXJmYWNlIHtcbiAgYmFzZT86IG51bWJlcjtcbiAgY29sb3JOZWdhdGl2ZT86IHN0cmluZztcbiAgY29sb3JQb3NpdGl2ZT86IHN0cmluZztcbiAgZHJhd1plcm9MaW5lPzogYm9vbGVhbjtcbiAgbWF4PzogbnVtYmVyO1xuICBtaW4/OiBudW1iZXI7XG4gIHNob3dWYWx1ZT86IGJvb2xlYW47XG4gIHdpZHRoPzogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFJhbmdlSW50ZXJmYWNlIHtcbiAgZnJvbTogbnVtYmVyIHwgRGF0ZSB8IG51bWJlcltdO1xuICB0bzogbnVtYmVyIHwgRGF0ZSB8IG51bWJlcltdO1xuICBjb2xvcj86IHN0cmluZztcbiAgYmdjb2xvcj86IHN0cmluZztcbiAgZnJvbUJnQ29sb3I/OiBzdHJpbmc7XG4gIHRvQmdDb2xvcj86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDb2xvckZvcm1hdEludGVyZmFjZSB7XG4gIHJhbmdlcz86IFJhbmdlSW50ZXJmYWNlW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGF0ZUZvcm1hdCB7XG4gIGZvcm1hdFR5cGU/OiBzdHJpbmc7XG4gIHBhdHRlcm4/OiBzdHJpbmc7XG4gIHRpbWVab25lPzogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE51bWJlckZvcm1hdEludGVyZmFjZSB7XG4gIGRlY2ltYWxTeW1ib2w/OiBzdHJpbmc7XG4gIGZyYWN0aW9uRGlnaXRzPzogbnVtYmVyO1xuICBncm91cGluZ1N5bWJvbD86IHN0cmluZztcbiAgbmVnYXRpdmVDb2xvcj86IHN0cmluZztcbiAgbmVnYXRpdmVQYXJlbnM/OiBib29sZWFuO1xuICBwYXR0ZXJuPzogc3RyaW5nO1xuICBwcmVmaXg/OiBzdHJpbmc7XG4gIHN1ZmZpeD86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQYXR0ZXJuRm9ybWF0SW50ZXJmYWNlIHtcbiAgcGF0dGVybjogc3RyaW5nO1xuICBkc3RDb2x1bW5JbmRleD86IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBGb3JtYXR0ZXJJbnRlcmZhY2Uge1xuICB0eXBlOiBzdHJpbmc7XG4gIG9wdGlvbnM/OiAoXG4gICAgQXJyb3dGb3JtYXRJbnRlcmZhY2VcbiAgICB8IEJhckZvcm1hdEludGVyZmFjZVxuICAgIHwgQ29sb3JGb3JtYXRJbnRlcmZhY2VcbiAgICB8IERhdGVGb3JtYXRcbiAgICB8IE51bWJlckZvcm1hdEludGVyZmFjZVxuICAgIHwgUGF0dGVybkZvcm1hdEludGVyZmFjZVxuICApO1xuICBjb2x1bW5zOiBudW1iZXJbXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBHb29nbGVDaGFydHNEYXRhVGFibGVJbnRlcmZhY2Uge1xuICBkYXRhVGFibGU/OiBhbnk7XG4gIGZpcnN0Um93SXNEYXRhPzogYm9vbGVhbjtcbiAgcXVlcnk/OiBzdHJpbmc7XG4gIGRhdGFTb3VyY2VVcmw/OiBzdHJpbmc7XG5cbiAgLyoqIFJlZnJlc2ggaW50ZXJ2YWwsIGluIHNlY29uZHMsIHdoZW4gdXNpbmcgcmVtb3RlIGRhdGEgc291cmNlLiAqL1xuICByZWZyZXNoSW50ZXJ2YWw/OiBudW1iZXI7XG5cbiAgLyoqIFRpbWVvdXQgaW4gc2Vjb25kcywgd2hlbiB1c2luZyByZW1vdGUgZGF0YSBzb3VyY2UgKi9cbiAgdGltZW91dD86IG51bWJlcjtcblxuICAvKiogQ2FsbGVkIGFmdGVyIHF1ZXJ5IGV4ZWN1dGVkLiBEYXRhVGFibGUgaXMgdXBkYXRlZCBhdXRvbWF0aWNhbGx5LlxuICAgKiBAcGFyYW0gcXVlcnlSZXNwb25zZSBnb29nbGUudmlzdWFsaXphdGlvbi5RdWVyeVJlc3BvbnNlXG4gICAqL1xuICBxdWVyeUNhbGxiYWNrPzogKHF1ZXJ5UmVzcG9uc2U6IGFueSkgPT4gYW55O1xuXG4gIGZvcm1hdHRlcnM/OiBGb3JtYXR0ZXJJbnRlcmZhY2VbXTtcbiAgdmlldz86IHN0cmluZyB8IG9iamVjdCB8IG9iamVjdFtdO1xufVxuXG5pbXBvcnQge1xuICBFdmVudEVtaXR0ZXIsXG4gIE91dHB1dCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmV4cG9ydCBjbGFzcyBHb29nbGVDaGFydHNEYXRhVGFibGUge1xuICBwcml2YXRlIGRhdGFUYWJsZTogYW55O1xuICBwdWJsaWMgcXVlcnk6IGFueTtcbiAgcHVibGljIHRpZDogYW55O1xuXG4gIEBPdXRwdXQoKSBkYXRhVGFibGVDaGFuZ2VkOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG9wdDogR29vZ2xlQ2hhcnRzRGF0YVRhYmxlSW50ZXJmYWNlKSB7XG4gICAgaWYgKG9wdCkge1xuICAgICAgdGhpcy5fc2V0RGF0YVRhYmxlKG9wdC5kYXRhVGFibGUsIG9wdC5maXJzdFJvd0lzRGF0YSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZW5kKCkge1xuICAgIGlmICh0aGlzLnF1ZXJ5ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5xdWVyeS5zZW5kKChxdWVyeVJlc3BvbnNlOiBhbnkpID0+IHtcbiAgICAgIHRoaXMuc2V0RGF0YVRhYmxlKHF1ZXJ5UmVzcG9uc2UuZ2V0RGF0YVRhYmxlKCkpO1xuICAgICAgaWYgKHRoaXMub3B0LnF1ZXJ5Q2FsbGJhY2spIHtcbiAgICAgICAgdGhpcy5vcHQucXVlcnlDYWxsYmFjayhxdWVyeVJlc3BvbnNlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBpbml0KG9wdD86IEdvb2dsZUNoYXJ0c0RhdGFUYWJsZUludGVyZmFjZSkge1xuICAgIGlmIChvcHQpIHtcbiAgICAgIHRoaXMub3B0ID0gb3B0O1xuICAgIH1cblxuICAgIGlmICh0aGlzLnRpZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAvLyBkb2Vzbid0IHdvcmssIHNlZSBodHRwczovL2dpdGh1Yi5jb20vZ29vZ2xlL2dvb2dsZS12aXN1YWxpemF0aW9uLWlzc3Vlcy9pc3N1ZXMvMjM4MVxuICAgICAgLy8gdGhpcy5xdWVyeS5hYm9ydCgpO1xuICAgICAgd2luZG93LmNsZWFySW50ZXJ2YWwodGhpcy50aWQpO1xuICAgICAgdGhpcy50aWQgPSB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMub3B0LmRhdGFTb3VyY2VVcmwpIHtcbiAgICAgIHRoaXMucXVlcnkgPSBuZXcgZ29vZ2xlLnZpc3VhbGl6YXRpb24uUXVlcnkodGhpcy5vcHQuZGF0YVNvdXJjZVVybCk7XG4gICAgICBpZiAodGhpcy5vcHQucXVlcnkpIHtcbiAgICAgICAgdGhpcy5xdWVyeS5zZXRRdWVyeSh0aGlzLm9wdC5xdWVyeSk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5vcHQudGltZW91dCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRoaXMucXVlcnkuc2V0VGltZW91dCh0aGlzLm9wdC50aW1lb3V0KTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLm9wdC5yZWZyZXNoSW50ZXJ2YWwpIHtcbiAgICAgICAgLy8gdGhpcy5xdWVyeS5zZXRSZWZyZXNoSW50ZXJ2YWwodGhpcy5vcHQucmVmcmVzaEludGVydmFsKTtcbiAgICAgICAgdGhpcy50aWQgPSB3aW5kb3cuc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgICAgIHRoaXMuc2VuZCgpO1xuICAgICAgICB9LCB0aGlzLm9wdC5yZWZyZXNoSW50ZXJ2YWwgKiAxMDAwKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuc2VuZCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNldERhdGFUYWJsZSh0aGlzLm9wdC5kYXRhVGFibGUpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJucyBVbmRlcmx5aW5nIGdvb2dsZS52aXN1YWxpemF0aW9uLkRhdGFUYWJsZVxuICAgKi9cblxuICBwdWJsaWMgZ2V0RGF0YVRhYmxlKCkge1xuICAgIHJldHVybiB0aGlzLmRhdGFUYWJsZTtcbiAgfVxuXG4gIHB1YmxpYyBzZXREYXRhVGFibGUoZHQ6IGFueSwgZmlyc3RSb3dJc0RhdGE/OiBib29sZWFuKSB7XG4gICAgaWYgKGZpcnN0Um93SXNEYXRhID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGZpcnN0Um93SXNEYXRhID0gdGhpcy5vcHQuZmlyc3RSb3dJc0RhdGE7XG4gICAgfVxuICAgIHRoaXMuX3NldERhdGFUYWJsZShkdCwgZmlyc3RSb3dJc0RhdGEpO1xuICAgIHRoaXMuZGF0YVRhYmxlQ2hhbmdlZC5lbWl0KHRoaXMuZGF0YVRhYmxlKTtcbiAgfVxuXG4gIHByaXZhdGUgX3NldERhdGFUYWJsZShkdDogYW55LCBmaXJzdFJvd0lzRGF0YT86IGJvb2xlYW4pIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShkdCkpIHtcbiAgICAgIGR0ID0gZ29vZ2xlLnZpc3VhbGl6YXRpb24uYXJyYXlUb0RhdGFUYWJsZShkdCwgZmlyc3RSb3dJc0RhdGEpO1xuICAgIH1cbiAgICB0aGlzLmRhdGFUYWJsZSA9IGR0O1xuICAgIHRoaXMucmVmb3JtYXQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBcHBsaWVzIGZvcm1hdHRlcnMgdG8gZGF0YSBjb2x1bW5zLCBpZiBkZWZpbmVkXG4gICAqL1xuXG4gIHB1YmxpYyByZWZvcm1hdCgpIHtcbiAgICBjb25zdCBkdCA9IHRoaXMuZGF0YVRhYmxlO1xuICAgIGlmIChkdCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHRoaXMub3B0LmZvcm1hdHRlcnMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgZm9ybWF0dGVyQ29uZmlnIG9mIHRoaXMub3B0LmZvcm1hdHRlcnMpIHtcbiAgICAgIGxldCBmb3JtYXR0ZXI6IGFueTtcbiAgICAgIGlmIChmb3JtYXR0ZXJDb25maWcudHlwZSA9PT0gJ1BhdHRlcm5Gb3JtYXQnKSB7XG4gICAgICAgIGNvbnN0IGZtdE9wdGlvbnMgPSBmb3JtYXR0ZXJDb25maWcub3B0aW9ucyBhcyBQYXR0ZXJuRm9ybWF0SW50ZXJmYWNlO1xuICAgICAgICBmb3JtYXR0ZXIgPSBuZXcgZ29vZ2xlLnZpc3VhbGl6YXRpb24uUGF0dGVybkZvcm1hdChmbXRPcHRpb25zLnBhdHRlcm4pO1xuICAgICAgICBmb3JtYXR0ZXIuZm9ybWF0KGR0LCBmb3JtYXR0ZXJDb25maWcuY29sdW1ucywgZm10T3B0aW9ucy5kc3RDb2x1bW5JbmRleCk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBmb3JtYXR0ZXJDb25zdHJ1Y3RvciA9IGdvb2dsZS52aXN1YWxpemF0aW9uW2Zvcm1hdHRlckNvbmZpZy50eXBlXTtcbiAgICAgIGNvbnN0IGZvcm1hdHRlck9wdGlvbnMgPSBmb3JtYXR0ZXJDb25maWcub3B0aW9ucztcbiAgICAgIGZvcm1hdHRlciA9IG5ldyBmb3JtYXR0ZXJDb25zdHJ1Y3Rvcihmb3JtYXR0ZXJPcHRpb25zKTtcbiAgICAgIGlmIChmb3JtYXR0ZXJDb25maWcudHlwZSA9PT0gJ0NvbG9yRm9ybWF0JyAmJiBmb3JtYXR0ZXJPcHRpb25zKSB7XG4gICAgICAgIGNvbnN0IGZtdE9wdGlvbnMgPSBmb3JtYXR0ZXJPcHRpb25zIGFzIENvbG9yRm9ybWF0SW50ZXJmYWNlO1xuICAgICAgICBmb3IgKGNvbnN0IHJhbmdlIG9mIGZtdE9wdGlvbnMucmFuZ2VzKSB7XG4gICAgICAgICAgaWYgKHR5cGVvZiAocmFuZ2UuZnJvbUJnQ29sb3IpICE9PSAndW5kZWZpbmVkJ1xuICAgICAgICAgICAgICAmJiB0eXBlb2YgKHJhbmdlLnRvQmdDb2xvcikgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICBmb3JtYXR0ZXIuYWRkR3JhZGllbnRSYW5nZShyYW5nZS5mcm9tLCByYW5nZS50byxcbiAgICAgICAgICAgICAgcmFuZ2UuY29sb3IsIHJhbmdlLmZyb21CZ0NvbG9yLCByYW5nZS50b0JnQ29sb3IpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBmb3JtYXR0ZXIuYWRkUmFuZ2UocmFuZ2UuZnJvbSwgcmFuZ2UudG8sIHJhbmdlLmNvbG9yLCByYW5nZS5iZ2NvbG9yKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgZm9yIChjb25zdCBjb2wgb2YgZm9ybWF0dGVyQ29uZmlnLmNvbHVtbnMpIHtcbiAgICAgICAgZm9ybWF0dGVyLmZvcm1hdChkdCwgY29sKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==